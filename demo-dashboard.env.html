<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/paper-material/paper-material.html">
<link rel="import" href="/bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="/bower_components/iron-pages/iron-pages.html">
<link rel="import" href="/bower_components/number-chart/number-chart.html">
<link rel="import" href="/bower_components/google-chart-elasticsearch/google-chart.html">
<link rel="import" href="/bower_components/tweet-chart/tweet-chart.html">

<style type="text/css">
  .bg-orange.number-chart{
    background-color: orange !important;
    color: white;
  } 
  .bg-yellow.number-chart {
    background-color: #9d33ff !important;
    color: white;
  }
</style>

<dom-module id="demo-dashboard">

  <link rel="import" type="css" href="demo-dashboard.css">
  <link rel="import" href="/styles/app-theme.html" type="css">
  <link rel="import" href="/styles/main.css" type="css">

  <template>
    <iron-ajax auto
        url="queries.json"
        handle-as="json"
        last-response="{{queries}}"></iron-ajax>

    <paper-tabs selected="{{selected}}">
      <paper-tab>Dashboard</paper-tab>
      <paper-tab>Sparql Editor</paper-tab>
    </paper-tabs>

    <iron-pages selected="{{selected}}">
      <div col="row">
      <number-chart 
          data="{{data}}"
          aggkey="theme"
          title="Transmite solo su trastorno de sueño"
          subtitle="Total"
          stylebg="bg-red"
          object="Transmite solo su trastorno de sueño">
      </number-chart>
      <number-chart 
          data="{{data}}"
          aggkey="theme"
          title="Transmite su trastorno de sueño y da las causas de su problema"
          subtitle="Total"
          stylebg="bg-yellow"
          object="Transmite su trastorno de sueño y da las causas de su problema">
      </number-chart>
       <number-chart 
          data="{{data}}"
          aggkey="theme"
          title="Transmite su trastorno de sueño y solicita ayuda"
          subtitle="Total"
          stylebg="bg-green"
          object="Transmite su trastorno de sueño y solicita ayuda">
      </number-chart>
       <number-chart 
          data="{{data}}"
          aggkey="theme"
          title="Transmite su trastorno de sueño y comenta la actividad que hace durante la noche"
          subtitle="Total"
          stylebg="bg-aqua"
          object="Transmite su trastorno de sueño y comenta la actividad que hace durante la noche">
      </number-chart>
       <number-chart 
          data="{{data}}"
          aggkey="theme"
          title="Transmite su trastorno del sueño e indica la medida en su vida diaria durante la noche que toma para intentar evitarlo"
          subtitle="Total"
          stylebg="bg-orange"
          object="Transmite su trastorno del sueño e indica la medida en su vida diaria durante la noche que toma para intentar evitarlo">
      </number-chart>
      <tweet-chart
        datos="{{data}}"
        field="text"
        fields='["sentiment","name","text"]' 
        icon='face'>
      </tweet-chart>


      </div>
      <div>
        PESTAÑA 2
      </div>
    </iron-pages>

  </template>

  <script>
  var ready = false;
    Polymer({
      is: 'demo-dashboard',
      properties: {
        selected: {
          type: Number,
          value: 0
        }, 

        ids:{
          type: Array
          /*value: ["481","482","32512","32420","91963","96677","160677","131425","322429","322612"]*/
           
        },
        data:{
          type: Object
        },
        client: {
          type: Object,
          notify: true,
          observer: '_clientChanged'              
        },
        fields: {
          type: Array,
          value: function() { return []; }
        },

        places: {
          type: Array,
          notify: true,
          value: []
        },

        filters: {
          type: Array,
          notify: true,
          value: function() { return []; }
        }
      },
    
      observers: [
      '_filtersChange(filters.*)'
      ],

      ready: function(){
        console.log("ready");
      },
      
      addPlace: function(event) {
        this.set('places', this.places.concat(event.detail.response))
        console.log(this.places)
      },
      
      getName: function(id) {
        return "http://tour-pedia.org/api/getPlaceDetails?id=" + id
      },
      
      getPoints: function(f) {
        return f.base;
      },

      _clientChanged: function() {
        console.log("ClientChanged");
        ready = true;
        this._query();
      },
      _filtersChange: function() {
        this._query();
       },
       _query: function() {
        console.log("_filtersChangedash")
        var that = this;
        console.log("Ready?: ", ready);
        if(ready){
          this.client.search({
          // undocumented params are appended to the query string
          index: "tweetsinsomnio",
          type: "tweet",
          body: {
            size: 10,
            query: {
              bool: {
                must: this.filters,
              }
            },
            aggs: {
              theme: {
                terms: {
                  field: "theme.keyword",
                  order: {
                    _count: "desc"
                  }
                }
              },
              sentiment: {
                terms: {
                  field: "sentiment.keyword",
                  order: {
                    _count: "desc"
                  }
                }
              },
              numReviews: {
                terms: {
                  field: "numReviews",
                  order: {
                    _count: "desc"
                  }
                }
              },
              polarity: {
                terms: {
                  field: "polarity",
                  order: {
                    _count: "desc"
                  }
                }
              }
            }      
          }
          }).then(function (resp) {
            var myids = []
            resp.hits.hits.forEach(function(entry){myids.push(entry._id)})
            that.ids = myids;
            //console.log(that.ids)
            that.data = resp;
            //console.log(that.data)
            
            });
        }
      }
    });
  </script>

</dom-module>
